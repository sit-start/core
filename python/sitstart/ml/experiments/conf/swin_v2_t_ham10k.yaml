# 88.1% val rec: https://wandb.ai/kevdale/swin_v2_t_ham10k_alt/runs/3a464_00003
defaults:
  - _defaults_
  - trial/data: ham10k
  - trial/model: swin_v2_t
  - _self_
eval:
  test:
    metrics:
      rec:
        _target_: sitstart.ml.metrics.AverageMulticlassRecall
        num_classes: 7 # ${trial.data.num_classes}
  train:
    # don't track train split metrics since we're using cutmix/mixup
    metrics: null
  select:
    metric: val_rec
    mode: max
max_num_epochs: 50
name: swin_v2_t_ham10k_alt
param_space:
  train_loop_config:
    loss_fn: ${rt.grid_search:[focal]} # note
    gamma: ${rt.grid_search:[2.5]}
    lr: ${rt.grid_search:[3e-5]}
    train_feat: ${rt.grid_search:['1234567']}
    rebalance_gamma: ${rt.grid_search:[0.25]}
    criteria_gamma: ${rt.grid_search:[0.5]}
    augment: ${rt.grid_search:[1]}
    t_max_scale: ${rt.grid_search:[1.0]}
    batch_xform: ${rt.grid_search:[CutMixUp]}
trial:
  data:
    batch_size: 12
    module:
      augment: ${if:${param_space.train_loop_config.augment},${trial.data.augment.transform},null}
      collate:
        _target_: sitstart.ml.transforms.${param_space.train_loop_config.batch_xform}CollateTransform
        num_classes: ${trial.data.num_classes}
      criteria_gamma: ${param_space.train_loop_config.criteria_gamma}
      dedupe: true
      rebalance_gamma: ${param_space.train_loop_config.rebalance_gamma}
  loss_fn:
    _target_: sitstart.ml.losses.FocalLoss
    gamma: ${param_space.train_loop_config.gamma}
  model:
    target_size: { crop: 443, resize: 450 }
    module:
      require_grad:
        - "-"
        - features.[${param_space.train_loop_config.train_feat}]
        - norm
        - head
  optimizer:
    _partial_: true
    _target_: torch.optim.AdamW
    lr: ${param_space.train_loop_config.lr}
    weight_decay: 1e-8
tune:
  scheduler:
    grace_period: ${max_num_epochs}
